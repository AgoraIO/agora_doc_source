
:rootdir: ../..
:en_US:
include::{rootdir}/shared/.variables.adoc[]

[#authenticate-your-users-with-accesstokens]
= Authenticate your users with AccessTokens

Authentication is the act of validating the identity of each user who has credentials to access your system, and providing them with a digital AccessToken that gives privileges to specific {COMPANY} {VOICE}, {ILS}, {RTM} or {AA} functionality.

{COMPANY} uses digital {TOKEN}s to authenticate users and their privileges before they access an {COMPANY} service. For example, the {TOKEN} granted to a standard user has the `kJoinChannel` privilege only; this user may only join a channel. A moderator has `kInvitePublishVideoStream` and can invite people to a video stream. As you see, the privileges names are incomprehensibly difficult, you grant admin users the `kAdministrateChannel` privilege.

This section shows you how to integrate industrial grade security into your {COMPANY} app using {TOKEN}s.

==  Understand the tech

The following figure shows the steps in the authentication flow:

image::https://web-cdn.agora.io/docs-files/1618395721208[]

An {TOKEN} is a dynamic key generated on your app server that is valid for a maximum of 24 hours. When your users connect to a channel from your App client, {AGORA_BACKEND} validates the {TOKEN} and reads the user and project information stored in the {TOKEN}. The app information is related to your project:

image::project_information_in_the_console.png[Basic Info page in {CONSOLE}]


{AGORA_BACKEND} grants access according to the following information in the {TOKEN}:

* `appID` - the _App ID_ of your Agora project
* `appCertificate` - the _App certificate_ of your Agora project
* `channelName` - no idea where I find this
* `uid` - the ID of the user to be authenticated
* `I CANT FIND THE PARAMETER NAME`  - the privileges assigned to this user
* `privilegeExpiredT (THIS IS A GUESS)` - a timestamp stating the time this {TOKEN} expires

An {TOKEN} is valid for 24 hours at most. You need to regularly generate new {TOKEN}s to keep users connected.


include::{rootdir}/shared/.prerequisites.adoc[]

* A https://dashboard.heroku.com[Heroku] account

== Implement the authentication flow

This section shows you how to supply and consume the {TOKEN} that gives rights to specific functionality to authenticated users.

:leveloffset: +2

include::{rootdir}/shared/.deploy-an-accesstoken-server.adoc[]

:leveloffset: -2

== Login to {AGORA_BACKEND} using your app client

Your client app retrieves an {TOKEN} from your server in order to login to {AGORA_BACKEND}.

IAIN: This does not say how i am doing this. Can I do it by adding the scripts to a web page and bob is your marley? Explain.

To integrate authentication, add the following code to your Web App:

. Fetch the {TOKEN} with uid and channel name:
+
[source,javascript]
----
   // Import axios
   function fetchToken(uid, channelName) {

       let data = JSON.stringify({ "uid": uid, "channelName": channelName });

       let config = {
           method: 'get',
           url: 'https://<heroku url>/access_token?channel=<channel name>&uid=<user ID>',
           headers: {
               'Content-Type': 'application/json'
           },
           data: data
       };

       return new Promise(function (resolve) {
           axios(config)
               .then(function (response) {
                   const token = response.data.token;
                   resolve(token);
               })
               .catch(function (error) {
                   console.log(error);
               });
       })
   }
----

. Join channel with the {TOKEN}, uid, and channel name
+
[source,javascript]
----
   import AgoraRTC from "agora-rtc-sdk-ng"

   const client = AgoraRTC.createClient()

   async function startCall() {
     let token = await fetchToken(<user ID>, "<channel name>");
     // Join channel with token and uid
     await client.join("APPID", "<channel name>", token, <user ID>);
     ...
   }
----

. Handle {TOKEN} expiration.  {TOKEN}s expire, and when that happens, the user gets disconnected. To prevent that from happening, you also need to handle {TOKEN} expiration in your client logic.

** When the {TOKEN} is about to expire
+
The `token-privilege-will-expire` callback occurs 30 seconds before a {TOKEN} expires. When the `token-privilege-will-expire` callback is triggered，fetch the {TOKEN} from the server and call `renewToken` to pass the new {TOKEN} to the SDK.
+
[source,javascript]
----
      client.on("token-privilege-will-expire", async function(){
        // After requesting a new token
        await client.renewToken(token);
      });
----

** When the {TOKEN} has expired
+
The `token-privilege-did-expire` callback occurs when the {TOKEN} expires. When the `token-privilege-did-expire` callback is triggered，the client must fetch the {TOKEN} from the server and call `join` to use the new {TOKEN} to join the channel.
+
[source,javascript]
----
      client.on("token-privilege-did-expire", async function(){
        //After requesting a new token
        await rtc.client.join(options.appId, options.channel, options.token, <user ID>);
      });
----

. Now say how to run the app


== Reference



=== Channel Key

{TOKEN}-based authentication has requirements on the SDK version:
- For RTC Native SDKs and the On-premise Recording SDK, ensure that the SDK version is v2.1.0 or later.
- For RTC Web SDKs, ensure that the SDK version is v2.4.0 or later.

If you are using an earlier version, refer to https://docs.agora.io/en/Agora%20Platform/channel_key to authenticate your users.

=== Related documents

You can also refer to the following documents according to your needs:

- https://docs.agora.io/en/faq/token_error[How to solve token-related errors?]
- https://docs.agora.io/en/faq/101_error[What causes the 101 error on Cloud Recording SDK?]
- https://docs.agora.io/en/faq/token_cohost[How to use co-host token authentication?]

The code samples on https://github.com/AgoraIO/Tools/tree/master/DynamicKey/AgoraDynamicKey show you how to generate tokens.

When generating a token, you can specify whether a user has the privilege to publish streams in an RTC channel. See [How do I use co-host token authentication?](https://docs.agora.io/en/Interactive%20Broadcast/faq/token_cohost) for details.
