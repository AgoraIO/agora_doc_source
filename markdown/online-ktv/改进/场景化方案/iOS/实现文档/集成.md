## 概述

为降低开发者的集成难度，声网为 K 歌房场景提供了场景化 API。场景化 API 封装了声网音视频 SDK 的 API，并提供了 K 歌业务常见的功能，例如，对主唱和伴唱进行 NTP 时间同步。你只需要调用一个场景化 API 即可实现通过多个音视频 SDK 的 API 完成的复杂代码逻辑，从而更轻松实现 K 歌场景。声网在 GitHub 上提供 KTV 场景化 API 的源码文件 [KTVApi.h](https://github.com/AgoraIO-Usecase/agora-ent-scenarios/blob/v2.1.1-ktv-iOS/iOS/AgoraEntScenarios/Scenes/KTV/ViewController/KTV/KTVApi.h) 和 [KTVApi.m](https://github.com/AgoraIO-Usecase/agora-ent-scenarios/blob/v2.1.1-ktv-iOS/iOS/AgoraEntScenarios/Scenes/KTV/ViewController/KTV/KTVApi.m)。

本文介绍如何使用 KTV 场景化 API 实现点歌、独唱、合唱等基础业务功能。

## 前提条件

实现点歌、独唱、合唱前，请确保你已完成如下步骤：

1. 参考<a href="https://docs.agora.io/cn/online-ktv/chorus_client_ios?platform=iOS#项目配置">项目配置</a>集成所需 SDK。
2. 在工程文件中引入 [KTVApi.h](https://github.com/AgoraIO-Usecase/agora-ent-scenarios/blob/v2.1.1-ktv-iOS/iOS/AgoraEntScenarios/Scenes/KTV/ViewController/KTV/KTVApi.h) 和 [KTVApi.m](https://github.com/AgoraIO-Usecase/agora-ent-scenarios/blob/v2.1.1-ktv-iOS/iOS/AgoraEntScenarios/Scenes/KTV/ViewController/KTV/KTVApi.m) 文件。

## 点歌

本节介绍如何实现点歌功能。点歌指用户通过浏览榜单或搜索关键词选定想唱的正版音乐，然后下载播放音乐。用户需要在唱歌前进行点歌。

### 方案介绍

下图展示点歌的 API 调用时序图：

![](https://web-cdn.agora.io/docs-files/1683360046603)

### 1. 初始化 KTV API 模块

实例化 `rtcEngine`、`musicCenter`、`musicPlayer`、`streamId` 实例，并将它们通过 `initWithRtcEngine` 方法传入 KTV API 模块。调用 KTV API 模块的 API 前，请确保已调用 `initWithRtcEngine` 初始化 KTV API 实例。

1. 调用 `sharedEngineWithAppId` 初始化 `AgoraRtcEngineKit`。

    ```objective-c
    // 初始化 AgoraRtcEngineKit
    // self.RTCkit 是定义的 AgoraRtcEngineKit 全局变量
    self.RTCkit = [AgoraRtcEngineKit sharedEngineWithAppId:<Your_Agora_Appid> delegate:self];
    [self.RTCkit setAudioScenario:AgoraAudioScenarioGameStreaming];
    [self.RTCkit setAudioProfile:AgoraAudioProfileMusicHighQuality];
    [self.RTCkit setChannelProfile:AgoraChannelProfileLiveBroadcasting];
    ```

2. 调用 [`sharedContentCenterWithConfig`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_drm.html#api_imusiccontentcenter_initialize) 初始化 `AgoraMusicContentCenter`。示例代码中需要传入 RTM Token。你可以参考[获取 RTM Token](/cn/Agora%20Platform/get_appid_token?platform=All%20Platforms#获取-rtm-token) 了解什么是 RTM Token，如何获取测试用途的临时 RTM Token，如何从服务器生成 RTM Token。

    ```objective-c
    // 初始化 AgoraMusicContentCenter
    AgoraMusicContentCenterConfig *contentCenterConfiguration = [[AgoraMusicContentCenterConfig alloc] init];
    contentCenterConfiguration.rtcEngine = self.RTCkit;
    contentCenterConfiguration.appId = "<Your_Agora_Appid>";
    contentCenterConfiguration.mccUid = <Your_Local_Uid>;
    contentCenterConfiguration.token = "<Your_Rtm_Token>";
    // self.AgoraMcc 是定义的 AgoraMusicContentCenter 的全局变量
    self.AgoraMcc = [AgoraMusicContentCenter sharedContentCenterWithConfig:contentCenterConfiguration];
    // 注册音乐内容中心回调
    [self.AgoraMcc registerEventDelegate:<Your_Delegate_Receiver>];
    [self.AgoraMcc enableMainQueueDispatch:YES];
    ```

3. 调用 [`createMusicPlayerWithDelegate`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_drm.html#api_imusiccontentcenter_createmusicplayer) 创建音乐播放器。

    ```objective-c
    // 创建音乐播放器
    self.rtcMediaPlayer = [self.AgoraMcc createMusicPlayerWithDelegate:<Your_MPK_DELEGATE_RECEIVER>];
    ```

4. 调用 [`createDataStream`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_stream_management.html#api_irtcengine_createdatastream2) 创建数据流

    ```objective-c
    // 创建数据流
    AgoraDataStreamConfig *config = [AgoraDataStreamConfig new];
    config.ordered = false;
    config.syncWithAudio = false;
    // ktvStreamId 是定义的可保存 Stream ID 的全局变量
    [self.RTCkit createDataStream:&ktvStreamId
                           config:config];
    ```

    <div class="alert note">考虑到数据流的消息通道有频率限制，为了确保 KTV 模块和其他模块不会相互影响，声网建议你在不同模块中为数据流创建的 <code>streamId</code> 都不同。例如，如果你在其他模块中也使用 <code>sendStreamMessage</code> 发送数据流，请确保两个模块中数据流的  <code>streamId</code> 不同。此外，每个用户在每个频道中最多只能创建 5 个数据流，请不要超出上限。</div>

5. 调用 `initWithRtcEngine` 初始化 KTV API 实例

    ```objective-c
    // 初始化 KTV API 实例
    val ktvApiProtocol = KTVApiImpl()
    self.ktvApi = [[KTVApi alloc] initWithRtcEngine:self.RTCkit channel:<YOUR_ROOM_CHANNEL> musicCenter:self.AgoraMcc player:self.rtcMediaPlayer dataStreamId:ktvApiStreamId delegate:self];
    ```

### 2. 获取歌曲列表

通过关键词搜索或音乐榜单获取歌曲列表。

```objective-c
// 用关键词搜索歌曲
- (void)loadSearchDataWithKeyWord:(NSString *)keyWord {
    NSDictionary *dict = @{
        @"pitchType":@(1),
        @"needLyric": @(YES), // 用来过滤没有歌词的歌曲
    };
    NSString *extra = [NSString convertToJsonData:dict];
    [self.agoraMcc searchMusicWithKeyWord:keyWord ? keyWord : @""
                                    page:self.page
                                pageSize:50
                              jsonOption:extra];
}
```

```objective-c
// 回调中获取通过关键词搜索的歌曲
- (void)onMusicCollectionResult:(nonnull NSString *)requestId
                         status:(AgoraMusicContentCenterStatusCode)status
                         result:(nonnull AgoraMusicCollection *)result {
}
```

```objective-c
// 用音乐榜单获取歌曲
- (void)loadDataWithIndex:(NSInteger)pageType {
    NSArray* chartIds = @[@(3), @(4), @(2), @(6)];
    NSInteger chartId = [[chartIds objectAtIndex:MIN(pageType - 1, chartIds.count - 1)] intValue];
    NSDictionary *dict = @{
        @"pitchType":@(1),
        @"needLyric": @(YES), // 用来过滤没有歌词的歌曲
    };
    NSString *extra = [NSString convertToJsonData:dict];
    [self.agoraMcc getMusicCollectionWithMusicChartId:chartId
                                                page:self.page
                                            pageSize:20
                                          jsonOption:extra];
}
```

```objective-c
// 回调中获取通过音乐榜单得到的歌曲
- (void)onMusicChartsResult:(NSString *)requestId
                     status:(AgoraMusicContentCenterStatusCode)status
                     result:(NSArray<AgoraMusicChartInfo*> *)result {
}
```

### 3. 加载歌曲

调用 `loadSong` 加载歌曲。该方法中你需要传入歌曲编号和 K 歌配置，例如当前的 K 歌场景（独唱或合唱）、用户角色、主唱伴唱的 UID。K 歌配置会决定 K 歌时歌曲的播放情况、各端用户的收发流情况等。歌曲加载结果会异步地通过 `block` 回调通知你。


```objective-c
// KTVSongType: 歌唱类型（合唱或独唱）
// KTVSingRole: K 歌用户角色
// songCode: 歌曲的编号
// mainSingerUid: 主唱 UID
// coSingerUid: 伴唱 UID。如果是独唱场景，不存在伴唱角色，那么传入 0 即可。
KTVSongConfiguration *config = [[KTVSongConfiguration alloc] init];
config.type = KTVSongTypeChorus | KTVSongTypeSolo;
config.role = KTVSingRoleMainSinger | KTVSingRoleCoSinger | KTVSingRoleAudience;
config.songCode = <Song_Code>;
config.mainSingerUid = <Main_Singer_UID>;
config.coSingerUid = <Chorus_Singer_UID>;

// 加载歌曲
[self.ktvApi loadSong:songCode withConfig:config withCallback:^(NSInteger songCode, NSString * _Nonnull lyricUrl, KTVSingRole role, KTVLoadSongState state) {
    KTVLogInfo(@"loadSong result: %ld",  state);
    if(state == KTVLoadSongStateOK) {
        // 歌曲加载成功的操作
        ...
    } else if(state == KTVLoadSongStateNoLyricUrl) {
        // 歌曲加载失败的操作
        ...
    }
}];
```


### 4. 播放歌曲

收到 `KTVLoadSongStateOK` 回调状态后，调用 `playSong` 开始播放歌曲。

```objective-c
[self.ktvApi loadSong:songCode withConfig:config withCallback:^(NSInteger songCode, NSString * _Nonnull lyricUrl, KTVSingRole role, KTVLoadSongState state) {
    KTVLogInfo(@"loadSong result: %ld",  state);
    if(state == KTVLoadSongStateOK) {
        // 歌曲加载成功，则播放歌曲
        [self.ktvApi playSong:songCode];
    } else if(state == KTVLoadSongStateNoLyricUrl) {
        // 否则重试三次
        if(weakSelf.retryCount < 2) {
            KTVLogInfo(@"songName: %@, songNo: %@, retryCount: %lu",model.songName, model.songNo,(unsigned long)weakSelf.retryCount);
            [weakSelf loadSongWithModel:model config:config];
            weakSelf.retryCount++;
        }
    }
}];
```

### 5. 监听并控制歌曲播放

歌曲播放时，音乐播放器会通过 `didChangedToState` 回调向业务层通知歌曲播放状态改变。收到 `didChangedToState(AgoraMediaPlayerStatePlaying)` 回调后，你可以使用 `seek`、`pause`、`resume`、`selectAudioTrack` 等方法控制播放器。

<div class="alert note">KTV API 模块内部会自动处理播放器同步，因此你也可以通过 <code>didChangedToState</code> 回调获取远端播放器的状态。</div>

```objective-c
// 跳转到指定时间播放歌曲
[self.ktvApi seek: time];
```

### 6. 停止歌曲播放

当歌曲播放完成或用户中途结束播放时，你需要主动调用 `stopSong` 停止播放。

```objective-c
[self.ktvApi stopSong];
```


## 独唱

本节介绍如何实现独唱功能。主唱点歌后，可以开始独唱，K 歌房内的听众都可以听到这位主唱唱歌。房间内想与主唱连麦语聊的听众可以上麦。

### 方案介绍

独唱场景下存在两种角色：

- 主唱：加入频道，加载并播放歌曲，发布麦克风采集的音频流。KTV API 模块内部控制音乐播放器播放音乐，发布音乐到远端，将音乐播放进度同步到远端，让歌词组件进入歌词滚动状态等逻辑。
- 听众：加入频道，加载歌曲。KTV API 模块内部控制听众订阅主唱的人声和音乐的音频合流，同步主唱的音乐播放进度，让歌词组件开始进入播放状态等逻辑。如果普通观众需要上麦聊天，可以更新媒体选项。

![](https://web-cdn.agora.io/docs-files/1678784206362)

下图展示独唱的 API 调用时序图：

![](https://web-cdn.agora.io/docs-files/1678788677280)

### 主唱实现

#### 1. 加入频道

调用 [`joinChannelByToken`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_joinchannel2) 让主唱加入频道。

```objective-c
// 加入频道
[self.RTCKit joinChannelByToken:<Your_Rtc_Token>
                      channelId:<Your_Channel_Name>
                             uid:<Your_Uid>
                    // 媒体选项详见第 5 步操作
                    mediaOptions:mediaOption
                     joinSuccess:nil];
```


#### 2. 播放歌曲

调用 `loadSong` 加载歌曲。歌曲加载结果会异步地通过 `block` 回调通知你。收到 `KTVLoadSongStateOK` 回调状态后，调用 `playSong` 开始播放歌曲。

```objective-c
KTVSongConfiguration *config = [[KTVSongConfiguration alloc] init];
config.type = KTVSongTypeSolo;
config.role = KTVSingRoleMainSinger;
config.songCode = <Song_Code>;
config.mainSingerUid = <Main_Singer_UID>;
// 独唱场景不存在伴唱角色，那么传入 0 即可。
config.coSingerUid = 0;
[self.ktvApi loadSong:songCode withConfig:config withCallback:^(NSInteger songCode, NSString * _Nonnull lyricUrl, KTVSingRole role, KTVLoadSongState state) {
    KTVLogInfo(@"loadSong result: %ld",  state);
    if(state == KTVLoadSongStateOK) {
        // 歌曲加载成功，则播放歌曲
        [self.ktvApi playSong:songCode];
    } else if(state == KTVLoadSongStateNoLyricUrl) {
        // 歌曲加载失败，则重试三次
        ...
    }
}];
```

#### 3. 停止播放

当歌曲播放完成或用户中途结束播放时，你需要主动调用 `stopSong` 停止播放。

```objective-c
[self.ktvApi stopSong];
```

#### 4. 关闭麦克风

主唱停止唱歌或希望暂时关闭麦克风时，可以调用 [`adjustRecordingSignalVolume`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_audio_process.html#api_irtcengine_adjustrecordingsignalvolume)，将音频采集信号音量设置为 0。

```objective-c
[self.RTCKit adjustRecordingSignalVolume: 0];
```

#### 5. 根据角色更新媒体选项

通过 [`updateChannelWithMediaOptions`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_updatechannelmediaoptions) 方法在主播加入频道后更新频道媒体选项，例如是否开启本地音频采集，是否发布本地音频流等。

```objective-c
AgoraRtcChannelMediaOptions* options = [AgoraRtcChannelMediaOptions new];
// 发布本地麦克风流
options.publishMicrophoneTrack = YES;
// 启用音频采集和播放
options.enableAudioRecordingOrPlayout = YES;
// 设置角色为主播
options.clientRoleType = AgoraClientRoleBroadcaster;
// 更新媒体选项
[self.RTCKit updateChannelWithMediaOptions:options];
```

### 听众实现

#### 1. 加入频道

调用 [`joinChannelByToken`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_joinchannel2) 让听众加入频道。

```objective-c
// 加入频道
[self.RTCKit joinChannelByToken:<Your_Rtc_Token>
                      channelId:<Your_Channel_Name>
                             uid:<Your_Uid>
                    // 媒体选项详见第 4 步操作
                    mediaOptions:mediaOption
                     joinSuccess:nil];
```

#### 2. 加载歌曲

调用 `loadSong` 加载歌曲。加载结果会异步地通过 `block` 回调通知你。收到 `KTVLoadSongStateOK` 回调状态后，调用 `playSong`。

听众加入频道后，默认订阅主唱发布的音频合流，即主唱人声和音乐混合的音频流。听众只需调用 `playSong` 进入歌曲播放状态即可。

```objective-c
KTVSongConfiguration *config = [[KTVSongConfiguration alloc] init];
config.type = KTVSongTypeSolo;
config.role = KTVSingRoleAudience;
config.songCode = <Song_Code>;
// 听众可以不传演唱者的 UID
config.mainSingerUid = 0;
config.coSingerUid = 0;
[self.ktvApi loadSong:songCode withConfig:config withCallback:^(NSInteger songCode, NSString * _Nonnull lyricUrl, KTVSingRole role, KTVLoadSongState state) {
    KTVLogInfo(@"loadSong result: %ld",  state);
    if(state == KTVLoadSongStateOK) {
        // 歌曲加载成功，则播放歌曲
        [self.ktvApi playSong:songCode];
    } else if(state == KTVLoadSongStateNoLyricUrl) {
        // 歌曲加载失败，则重试三次
        ...
    }
}];
```

#### 3. 停止播放

当歌曲播放完成或用户中途结束播放时，你需要主动调用 `stopSong` 停止播放。

```objective-c
[self.ktvApi stopSong];
```

#### 4. 根据角色更新媒体选项

通过 [`updateChannelWithMediaOptions`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_updatechannelmediaoptions) 方法在听众加入频道后更新频道媒体选项，例如是否开启本地音频采集，是否发布本地音频流等。

听众的用户角色为 `AgoraClientRoleAudience`，因此无法在频道内发布音频流。如果听众想上麦与主唱语聊，需要将用户角色修改为 `AgoraClientRoleBroadcaster`。修改角色后，SDK 默认发布该连麦听众的音频流，主唱和其他听众都能听到连麦听众的声音。

```objective-c
// 对需要上麦聊天的听众更新媒体选项
AgoraRtcChannelMediaOptions* options = [AgoraRtcChannelMediaOptions new];
// 发布本地麦克风流
options.publishMicrophoneTrack = true
// 启用音频采集和播放
options.enableAudioRecordingOrPlayout = true
// 设置角色为主播
options.clientRoleType = AgoraClientRoleBroadcaster
// 更新媒体选项
[self.RTCKit updateChannelWithMediaOptions:options];


// 对未上麦的听众更新媒体选项
AgoraRtcChannelMediaOptions* options = [AgoraRtcChannelMediaOptions new];
// 不发布本地麦克风流
options.publishMicrophoneTrack = false
// 启用音频采集和播放
options.enableAudioRecordingOrPlayout = true
// 设置角色为用户
options.clientRoleType = AgoraClientRoleAudience
// 更新媒体选项
[self.RTCKit updateChannelWithMediaOptions:options];
```

## 合唱

本节介绍如何实现合唱功能。主唱点歌开唱后，伴唱可以和主唱一起唱歌，K 歌房内的听众都可以听到合唱。房间内想与主唱或伴唱连麦语聊的听众可以上麦。

### 方案介绍

合唱场景下存在三种角色：

- 主唱：加入频道，加载并播放歌曲，发布麦克风采集的音频流。KTV API 模块内部控制音乐播放器播放音乐，发布音乐到远端，将音乐播放进度同步到远端，让歌词组件进入歌词滚动状态等逻辑。
- 伴唱：加入频道，加载并播放歌曲，发布麦克风采集的音频流。KTV API 模块内部控制音乐播放器播放音乐，同步主唱的音乐播放进度，让歌词组件进入歌词滚动状态等逻辑。
- 听众：加入频道，加载歌曲。KTV API 模块内部控制听众订阅主唱的人声和音乐的音频合流，订阅伴唱的人声，同步主唱的音乐播放进度，让歌词组件进入歌词滚动状态等逻辑。如果普通观众需要上麦聊天，可以更新媒体选项。

![](https://web-cdn.agora.io/docs-files/1678784685024)

下图展示合唱的 API 调用时序图：

![](https://web-cdn.agora.io/docs-files/1678866367772)

### 主唱实现

#### 1. 设置合唱私有参数

实时合唱场景对低延时和音质的要求很高。开启合唱前，你需要在初始化 `AgoraRtcEngineKit` 的方法里设置如下私有参数。

```objective-c
[self.RTCKit setParameters:@"{\"rtc.ntp_delay_drop_threshold\":1000}"];
[self.RTCKit setParameters:@"{\"rtc.enable_nasa2\": false}"];
[self.RTCKit setParameters:@"{\"rtc.video.enable_sync_render_ntp\": true}"];
[self.RTCKit setParameters:@"{\"rtc.net.maxS2LDelay\": 800}"];
```

#### 2. 加入频道

调用 [`joinChannelByToken`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_joinchannel2) 让主唱加入频道。

```objective-c
// 加入频道
[self.RTCKit joinChannelByToken:<Your_Rtc_Token>
                      channelId:<Your_Channel_Name>
                             uid:<Your_Uid>
                    // 媒体选项详见第 5 步操作
                    mediaOptions:mediaOption
                     joinSuccess:nil];
```

#### 3. 开始合唱

调用 `loadSong` 加载歌曲。歌曲加载结果会异步地通过 `block` 回调通知你。收到 `KTVLoadSongStateOK` 回调状态后，调用 `playSong` 开始播放歌曲，开始合唱。

```objective-c
KTVSongConfiguration *config = [[KTVSongConfiguration alloc] init];
config.type = KTVSongTypeChorus;
config.role = KTVSingRoleMainSinger;
config.songCode = <Song_Code>;
config.mainSingerUid = <Main_Singer_UID>;
// 主唱可以不填伴唱 UID，传 0 即可。
config.coSingerUid = 0;
[self.ktvApi loadSong:songCode withConfig:config withCallback:^(NSInteger songCode, NSString * _Nonnull lyricUrl, KTVSingRole role, KTVLoadSongState state) {
    KTVLogInfo(@"loadSong result: %ld",  state);
    if(state == KTVLoadSongStateOK) {
        // 歌曲加载成功，则播放歌曲
        [self.ktvApi playSong:songCode];
    } else if(state == KTVLoadSongStateNoLyricUrl) {
        // 歌曲加载失败，则重试三次
        ...
    }
}];
```

#### 4. 停止合唱

当歌曲播放完成或用户中途结束播放时，你需要主动调用 `stopSong` 停止播放，停止合唱。

```objective-c
[self.ktvApi stopSong];
```

#### 5. 根据角色更新媒体选项

通过 [`updateChannelWithMediaOptions`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_updatechannelmediaoptions) 方法在主播加入频道后更新频道媒体选项，例如是否开启本地音频采集，是否发布本地音频流等。

```objective-c
AgoraRtcChannelMediaOptions* options = [AgoraRtcChannelMediaOptions new];
// 发布本地麦克风流
options.publishMicrophoneTrack = YES;
// 启用音频采集和播放
options.enableAudioRecordingOrPlayout = YES;
// 设置角色为主播
options.clientRoleType = AgoraClientRoleBroadcaster;
// 更新媒体选项
[self.RTCKit updateChannelWithMediaOptions:options];
```

### 伴唱实现

#### 1. 设置合唱私有参数

实时合唱场景对低延时和音质的要求很高。开启合唱前，你需要在初始化 AgoraRtcEngineKit 的方法里设置如下私有参数。

```objective-c
[self.RTCKit setParameters:@"{\"rtc.ntp_delay_drop_threshold\":1000}"];
[self.RTCKit setParameters:@"{\"rtc.enable_nasa2\": false}"];
[self.RTCKit setParameters:@"{\"rtc.video.enable_sync_render_ntp\": true}"];
[self.RTCKit setParameters:@"{\"rtc.net.maxS2LDelay\": 800}"];
```

#### 2. 加入频道

调用 [`joinChannelByToken`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_joinchannel2) 让伴唱加入频道。

```objective-c
// 加入频道
[self.RTCKit joinChannelByToken:<Your_Rtc_Token>
                      channelId:<Your_Channel_Name>
                             uid:<Your_Uid>
                    // 媒体选项详见第 5 步操作
                    mediaOptions:mediaOption
                     joinSuccess:nil];
```

#### 3. 开始合唱

调用 `loadSong` 加载歌曲。歌曲加载结果会异步地通过 `block` 回调通知你。收到 `KTVLoadSongStateOK` 回调状态后，调用 `playSong` 开始播放歌曲，开始合唱。

```objective-c
KTVSongConfiguration *config = [[KTVSongConfiguration alloc] init];
config.type = KTVSongTypeChorus;
config.role = KTVSingRoleCoSinger;
config.songCode = <Song_Code>;
// 伴唱一定要填主唱 UID
config.mainSingerUid = <Main_Singer_UID>;
config.coSingerUid = <Chorus_Singer_UID>;
[self.ktvApi loadSong:songCode withConfig:config withCallback:^(NSInteger songCode, NSString * _Nonnull lyricUrl, KTVSingRole role, KTVLoadSongState state) {
    KTVLogInfo(@"loadSong result: %ld",  state);
    if(state == KTVLoadSongStateOK) {
        // 歌曲加载成功，则播放歌曲
        [self.ktvApi playSong:songCode];
    } else if(state == KTVLoadSongStateNoLyricUrl) {
        // 歌曲加载失败，则重试三次
        ...
    }
}];
```

#### 4. 停止合唱

当歌曲播放完成或用户中途结束播放时，你需要主动调用 `stopSong` 停止播放，停止合唱。

```objective-c
[self.ktvApi stopSong];
```

#### 5. 根据角色更新媒体选项

通过 [`updateChannelWithMediaOptions`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_updatechannelmediaoptions) 方法在伴唱加入频道后更新频道媒体选项，例如是否开启本地音频采集，是否发布本地音频流等。

```objective-c
AgoraRtcChannelMediaOptions* options = [AgoraRtcChannelMediaOptions new];
// 发布本地麦克风流
options.publishMicrophoneTrack = YES;
// 启用音频采集和播放
options.enableAudioRecordingOrPlayout = YES;
// 设置角色为主播
options.clientRoleType = AgoraClientRoleBroadcaster;
// 更新媒体选项
[self.RTCKit updateChannelWithMediaOptions:options];
```

### 听众实现

#### 1. 加入频道

调用 [`joinChannelByToken`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_joinchannel2) 让听众加入频道。

```objective-c
// 加入频道
[self.RTCKit joinChannelByToken:<Your_Rtc_Token>
                      channelId:<Your_Channel_Name>
                             uid:<Your_Uid>
                    // 媒体选项详见第 4 步操作
                    mediaOptions:mediaOption
                     joinSuccess:nil];
```

#### 2. 加载歌曲

调用 `loadSong` 加载歌曲。加载结果会异步地通过 `block` 回调通知你。收到 `KTVLoadSongStateOK` 回调状态后，调用 `playSong`。

听众加入频道后，默认订阅主唱人声和音乐混合的音频流，默认订阅伴唱人声。听众只需调用 `playSong` 进入歌曲播放状态即可。

```objective-c
KTVSongConfiguration *config = [[KTVSongConfiguration alloc] init];
config.type = KTVSongTypeChorus;
config.role = KTVSingRoleAudience;
config.songCode = <Song_Code>;
// 听众可以不传演唱者的 UID
config.mainSingerUid = 0;
config.coSingerUid = 0;
[self.ktvApi loadSong:songCode withConfig:config withCallback:^(NSInteger songCode, NSString * _Nonnull lyricUrl, KTVSingRole role, KTVLoadSongState state) {
        KTVLogInfo(@"loadSong result: %ld",  state);
        if(state == KTVLoadSongStateOK) {
            // 歌曲加载成功，则播放歌曲
            [self.ktvApi playSong:songCode];
        }
}];
```

#### 3. 停止播放

当歌曲播放完成或用户中途结束播放时，你需要主动调用 `stopSong` 停止播放。

```objective-c
[self.ktvApi stopSong];
```

#### 4. 根据角色更新媒体选项

通过 [`updateChannelWithMediaOptions`](https://docs.agora.io/cn/online-ktv/API%20Reference/ios_ng/API/toc_core_method.html#api_irtcengine_updatechannelmediaoptions) 方法在听众加入频道后更新频道媒体选项，例如是否开启本地音频采集，是否发布本地音频流等。

听众的用户角色为 `AgoraClientRoleAudience`，因此无法在频道内发布音频流。如果听众想上麦与主唱/伴唱语聊，需要将用户角色修改为 `AgoraClientRoleBroadcaster`。修改角色后，SDK 默认发布该连麦听众的音频流，主唱、伴唱、其他听众都能听到连麦听众的声音。

```objective-c
// 对需要上麦聊天的听众更新媒体选项
AgoraRtcChannelMediaOptions* options = [AgoraRtcChannelMediaOptions new];
// 发布本地麦克风流
options.publishMicrophoneTrack = true
// 启用音频采集和播放
options.enableAudioRecordingOrPlayout = true
// 设置角色为主播
options.clientRoleType = AgoraClientRoleBroadcaster
// 更新媒体选项
[self.RTCKit updateChannelWithMediaOptions:options];


// 对未上麦的听众更新媒体选项
AgoraRtcChannelMediaOptions* options = [AgoraRtcChannelMediaOptions new];
// 不发布本地麦克风流
options.publishMicrophoneTrack = false
// 启用音频采集和播放
options.enableAudioRecordingOrPlayout = true
// 设置角色为用户
options.clientRoleType = AgoraClientRoleAudience
// 更新媒体选项
[self.RTCKit updateChannelWithMediaOptions:options];
```

## API 参考

本文集成步骤中使用如下 API：
- [RTC API](/cn/online-ktv/API%20Reference/ios_ng/API/rtc_api_overview_ng.html)
- [场景化 API](/cn/online-ktv/ktv_api_oc?platform=iOS)