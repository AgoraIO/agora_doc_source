Agora 即时通讯支持 HTTP 回调（Webhook）。为你的即时通讯应用设置 HTTP 回调后，当指定事件发生时，Agora 即时通讯服务器会以 HTTP POST 请求的形式向你的应用服务器发送通知。

你可以使用 HTTP 回调在你自己的服务器上同步消息，或审核消息内容。

## 技术原理

根据消息投递是否被干预，回调分为两类：
- 发送前回调：主要用于内容审核。当 Agora 即时通讯服务器收到来自客户端 app 的消息时，它会向你的应用服务器发送请求并等待响应来决定是否投递消息。发送前回调仅适用于从你的客户端 app 发送的消息。
- 发送后回调：主要用于数据同步。当某些事件发生时，例如用户发送消息或离线，Agora 即时通讯服务器会向你的应用服务器发送请求，并且不会验证响应内容。发送后回调适用于从你的客户端和服务端发送的消息及其他事件。

下表总结了两类回调之间的区别。

| 类别 | 发送前回调 | 发送后回调 |
| ------------------- | --------------------- | ---------------------------- |
| 支持的平台 | 客户端 SDK | 客户端 SDK 和 REST API |
| 支持的事件 | 消息 | 消息和其他事件 |
| 需要响应 | 是 | 否 |
| 典型用例 | 内容审核 | 聊天记录同步 |

### 发送前回调

下图展示了发送前回调的工作流程。

![发送前回调工作流程](https://web-cdn.agora.io/docs-files/1642478214940)

如图，发送前回调的工作流程如下：

1. Agora 即时通讯服务器收到来自客户端 A 的消息。
2. Agora 即时通讯服务器向你的应用服务器发送包含消息信息的 HTTP 请求。
3. 你的应用服务器处理接收到的数据并得到消息投递是否通过的结果。
4. 你的应用服务器将处理结果以 HTTP 响应的形式发送到 Agora 即时通讯服务器。
5. Agora 即时通讯服务器接收到 HTTP 响应并决定是否投递消息。
6. 如果结果通过，则 Agora 即时通讯服务器将消息发送给客户端 B。


### 发送后回调

下图展示了发送后回调的工作流程。

![发送后回调工作流程](https://web-cdn.agora.io/docs-files/1642478242440)

如图，发送后回调的工作流程如下：

1. Agora 即时通讯服务器从客户端或服务端收到消息或其他事件。
2. Agora 即时通讯服务器向你的应用服务器发送包含消息或事件信息的 HTTP 请求。
3. 你的应用服务器向 Agora 即时通讯服务器发送 HTTP 响应，表示收到回调。

## 前提条件

要使用 HTTP 回调，必须满足以下要求：
- 有一个启用了 Agora 即时通讯的 Agora 项目。
- 已订阅 Agora 即时通讯进阶版或企业版套餐包，详见[管理套餐包](https://docs.agora.io/cn/agora-chat/agora_chat_pricing?platform=All%20Platforms#管理套餐包)。

## 配置回调规则

要接收 HTTP 回调，你需要在 Agora 控制台中配置发送前或发送后回调的规则。

1. 登录 Agora 控制台，在[项目管理](https://console.agora.io/projects)页面找到你的项目，然后点击编辑按钮。

1. 在项目编辑页面找到**即时通讯IM**，点击**配置**。

1. 在配置页面的**实时消息回调**部分点击**添加回调地址**。

   ![](https://web-cdn.agora.io/docs-files/1642479134679)

1. 要为发送前回调添加规则，在**发送前回调**选项卡下填写以下字段，然后单击**保存**。
   - 规则名称：输入规则的名称。在一个项目下，每条规则都必须有一个唯一的名称。
   - 会话类型：选择此规则适用的会话类型。
   - 消息类型：选择此规则适用的消息类型。
   - 等待响应时间：（可选）指定 Agora 即时通讯服务器等待 HTTP 响应的时间（单位为毫秒）。默认值为 200 毫秒。如果响应超时，Agora 即时通讯服务器将执行调用失败策略。
   - 调用失败策略：（可选）选择当 HTTP 响应超时或返回错误时 Agora 即时通讯服务器的操作。默认选项为放行。
   - 回调地址：输入用于接收发送前回调的应用服务器的 URL。支持 HTTP 和 HTTPS 地址。
   - 消息拦截报错时显示：（可选）设置当消息被拦截时是否通知消息发送方。默认选项是不通知消息发送方。

1. 要为发送后回调添加规则，填写**发送后回调**选项卡下的以下字段，然后单击**保存**。
   - 规则名称：输入规则的名称。在一个项目下，每条规则都必须有一个唯一的名称。
   - 回调服务：选择此规则适用的会话或事件类型。
   - 消息类型：选择此规则适用的消息类型。
   - 消息状态：选择此规则是适用于聊天消息还是离线消息，或两者都适用。
      - 要在你自己的服务器上同步聊天记录，请选择聊天消息。用户发送的所有消息都是聊天消息，与消息接收方的在线状态无关。
      - 要推送消息通知，请选择离线消息。发送给离线用户的消息为离线消息。
   - 回调地址：输入用于接收发送后回调的应用服务器的 URL。支持 HTTP 和 HTTPS 地址。

规则添加后立即生效。

注意事项：
- 默认情况下，发送前和发送后回调规则总计最多可以添加四个。如需添加更多规则，请[提交工单](https://agora-ticket.agora.io)。
- 规则配置仅支持消息事件。要接收其他事件的通知，请[提交工单](https://agora-ticket.agora.io)。
- 如果你同时设置了发送前和发送后回调，并且发送前回调触发后消息被拦截，则不会触发发送后回调。

## 后续步骤

为了增强回调的安全性，Agora 即时通讯在每个回调的请求正文中都包含一个签名。你可以通过验证签名来确认回调是否来自 Agora 即时通讯服务器。

要验证回调中的签名，参考以下步骤：

1. 获取下列信息：
   - 回调 ID，即回调请求体中的 `callId` 参数。
   - 分配给回调规则的密钥。你可以在 Agora 控制台的即时通讯 IM 配置页面找到该值。
      ![密钥截图](https://web-cdn.agora.io/docs-files/1642410707395)
   - 回调时间戳，即回调请求体中的 `timestamp` 参数。
2. 计算由回调 ID、密钥和回调时间戳拼接的字符串的[MD5](https://en.wikipedia.org/wiki/MD5) 值。
3. 检查计算的值是否等于请求正文中的 `secret` 参数。如果相等，则回调是由 Agora 即时通讯发送的。

## 参考

本节提供 HTTP 请求和响应的详细信息。

### HTTP 请求

当你的 Agora 即时通讯 app 中发生某些事件时，Agora 即时通讯服务器会发送带有 JSON payload 的 HTTP `POST` 请求。字符编码为 UTF-8。所有 HTTP 请求头中的 `Content-Type` 字段都是 `application/json`。


### HTTP 响应

对于发送前回调，Agora 即时通讯服务器接受包含 JSON 正文的 HTTP 响应，如下例所示：

```json
{
    "valid": true,
    "code": "HX:10000"
}
```

- `valid`：布尔值。根据你的应用服务器上的处理结果，消息是否有效：
   - `true`：消息有效，Agora 即时通讯服务器应该投递该消息。
   - `false`：消息无效，Agora 即时通讯服务器应该拦截该消息。
- `code`：字符串。自定义信息。

对于发送后回调，请确保响应内容不超过 1,000 个字符。

### 重试逻辑

- 对于发送前回调，如果你的应用服务器没有返回 HTTP 代码 200 和 `valid` 状态，则 Agora 即时通讯服务器不会重新发送回调，并执行相应规则指定的调用失败策略。

- 对于发送后回调，Agora 即时通讯服务器会在下列情况下记录一次通知失败，并立即尝试重新发送回调：

   - 你的服务器在 60 秒内没有响应。
   - 从你的服务器收到的 HTTP 状态码不是 200。

   如果第二次尝试失败，Agora 即时通讯服务器将停止尝试。如果在 30 秒内发生 90 次通知失败，则相应的回调规则会自动被禁用 5 分钟。