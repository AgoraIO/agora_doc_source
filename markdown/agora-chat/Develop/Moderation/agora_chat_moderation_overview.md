使用即时通讯 IM 服务时，你可以使用 IM 内容审核服务对消息内容进行多样化场景检测，帮助您对应用消息内容进行管控，规避内容违规风险。

- 可以使用以下消息管理工具：
  - 消息举报。
  - 消息审核，包括文本、图像和音视频审核。
- 消息审核可针对全局应用进行或应用于单聊或指定的群组或聊天室。

## 前提条件

- 完成 SDK 初始化，完成 SDK 初始化，详见 [Android](./agora_chat_get_started_android)、[iOS](./agora_chat_get_started_ios)、[Web](./agora_chat_get_started_web) 或[小程序](./agora_chat_get_started_applet)的快速开始。
- 开通即时通讯 IM 服务的进阶版或企业版。

### 开通审核服务

1. 登录[声网控制台](https://console.agora.io/)，在**项目管理**页面，选择需要开通即时通讯服务的项目，点击**配置**。

2. 在**服务配置**页面，点击**即时通讯**中的**配置**链接。

3. 在**功能配置** > **总览** 页面的 **内容审核功能配置** 区域开启特定审核选项。

![](./images/moderation/moderation_enable.png)
## 消息管理

即时通讯 IM 提供多种消息审核和过滤的能力：

| 功能           | 描述                                                         |
| :---------------- | :----- |
|消息举报|终端用户可调用消息举报 API 对不当消息进行举报。审核人员可在声网控制台查看举报记录，并对消息和消息发送者进行处理。|
|文本审核和图片审核|文本审核和图片审核基于第三方机器学习模型，自动审核文本和图片消息，并阻断可疑内容。|
|名单过滤|名单过滤服务根据你配置的敏感词词库对消息内容进行过滤。|
|域名过滤|域名过滤服务根据你配置的域名对消息内容进行检测和过滤。|
 
### 消息举报

如需使用消息举报功能，你需要在客户端集成相应 API。有关详细信息，请参阅以下文档：

- [实现举报功能（Android）](./agora_chat_reporting_android?platform=Android)
- [实现举报功能 (iOS)](./agora_chat_reporting_ios?platform=iOS)
- [实施举报功能（Web）](./agora_chat_reporting_web?platform=Web)

用户举报应用的消息后，审核人员可以在声网控制台查看和处理消息举报记录：

1. 在在声网控制台的[项目管理](https://console.agora.io/projects) 页面，找到已开启即时通讯服务的项目，点击 **配置**。

2. 在**服务配置**页面，点击**即时通讯**中的**配置**链接。 

3. 在即时通讯 IM 的左侧导航栏中选择 **消息举报** > **历史记录**，进入消息举报记录页面。

    ![](./images/moderation/moderation_report.png)

2. 在**消息举报**页面，审核人员可以按时间段、会话类型或处理方式过滤消息举报记录，也可以按用户 ID、群组 ID 或聊天室 ID 查询特定举报记录。对于举报的消息，即时通讯 IM 支持两种处理方式，即撤回消息或请求发送者处理消息。

### 消息内容审核 - 文本和图片审核

#### 概述

文本和图片审核是即时通讯 IM 提供的基于机器学习模型的审核服务，可以扫描用户消息中的违规文本和图片内容，并对违规内容进行标记，进行审核。即时通讯 IM 的文本和图片审核由 [Microsoft Azure Moderator](https://azure.microsoft.com/zh-cn/services/cognitive-services/content-moderator/) 提供支持。该模型将不当消息标记为以下三个类别：

- 成人：在某些情况下，内容可能被视为色情内容和成人内容。
- 成熟：某些情况下，内容被视为性暗示或过于成熟。
- 冒犯的：内容可能被视为攻击或辱骂。

你可以配置审核规则，对在一段时间内达到指定的违规次数的用户进行处罚：
- App 级别和单聊的处罚措施：
  - **封禁用户**：用户若被封禁将立即下线并无法登录即时通讯 IM，直到被解禁后才能恢复登录。例如，若某一用户在 1 分钟内发送违规内容达到 5 次，对该用户进行封禁。
  - **强制用户下线**：强制用户下线即将用户状态修改为离线，用户需要重新登录才能正常使用。
  - **删除用户**：移除违规的用户。如果违规用户为群主或者聊天室所有者，系统会同时删除对应的群组和聊天室。

- 群组和聊天室的处罚措施：
  - **加入黑名单**：若被加入群组或聊天室的黑名单，用户则无法查看或接收该群组或聊天室的消息。
  - **踢出**：用户被踢出群组或聊天室。被移除群组后，用户同时会被移除在该群组中加入的子区。
  - **禁言**：用户被禁言后，将无法在群组或聊天室中发送消息。若用户在群组中禁言，也无法在该群组下的子区中发送消息。

你可以在声网控制台测试不同的文本字符串和图像，从而了解审核的工作原理并确定哪些审核设置适合你的需求。

#### 创建审核规则

下文以单聊文本为例介绍如何添加审核规则：

1. 在即时通讯 IM 的左侧导航栏中选择**文本审核** > **规则配置**，进入文本审核规则配置页面。

   ![](./images/moderation/moderation_text_rule.png)

2. 单击**添加规则**创建文本审核规则：

   ![](./images/moderation/moderation_text_rule_create.png)

下表为规则中的字段描述：

| 字段                 | 描述                                                         |
| :------------------- | :----------------------------------------------------------- |
| 规则名称             | 审核规则的名称，为审核规则的唯一标识，不能超过 32 个字符。   |
| 会话类型             | 会话类型指审核规则生效的范围，包括：单聊会话以及单个、多个或所有群聊和聊天室会话；例如，选择单聊，表示依据该规则对应用下单聊的所有文本消息进行审核和处置。 |
| 启用规则 | 是否启用审核规则。启用后规则生效，关闭则规则不生效。         |
| 消息处理             | <li>审核结果为拒绝时，消息处理策略包括`拦截`、`替换为 ***`和`通过`；<li>审核结果为疑似时，消息处理策略包括`拦截`和`通过`；<li>审核服务调用失败时，消息处理策略包括`拦截`和`通过`；<li>消息拦截后客户端是否报错：`是`为报错；`否`为不报错。 |
| 审核模型             | 内容审核支持多场景模型，可按需选择。文本审核仅有 1 个通用违规内容审核模型，包含以下策略：涉政&违禁&暴恐&色情&辱骂&广告&灌水&无意义。 |
| 用户处理策略         | 默认不处理。开启后，可以设置时间间隔、触发次数和用户处理策略，触发该规则后将对用户进行自动处理。例如，**时间间隔**设置为 **3** 分钟，**触发次数**为 **3**，**用户管理**设置为**删除**，表示若用户在 3 分钟内发送的消息触发了这条审核规则 3 次会被自动移除。用户处理策略详情，请参见[用户管理](#usermanagement)。 |

设置消息处理策略具体如下：

| 审核结果               | 描述    | 消息处理                                                         |
| :-------------------- | :------ | :----------------------------------------------------------- |
| **通过**                 | 表示未发现违规内容。无需进行消息处理设置。| 下发消息。                                 |
| **拒绝**               | 表示发现违规内容，建议直接拦截。 | 拒绝发送消息。可设置是否下发消息：<li>（默认）**通过**：下发消息。当测试阶段需要验证审核模型是否符合业务预期而无需对消息产生影响，可采取该设置。 <li>**拦截**：拦截消息。若审核模型确认满足业务需求，需对线上消息生效，则采用该设置。<li>`替换为***`：将敏感词替换为 `***` 后再下发消息。|
| **疑似**        | 表示可能存在违规内容，建议人工审核。| 可设置是否下发消息：<li>**通过**：下发消息。<li>（默认）**拦截**：拦截消息。|
| **调用失败**             | 表示审核服务调用失败。审核服务没有在一定时间内返回审核结果，即认为调用失败，<br/> 例如，文本审核接口超时时间为 200 毫秒，若该时间内未返回审核结果，则视为异常（通常认定为异常会有 3 种原因：1. 没有调用权限；2. 返回时间超时；3.服务出现异常）。| 可设置是否下发消息：<li>**通过**：下发消息。<li>（默认）**拦截**：拦截消息。|

针对以上 4 种审核结果，若消息处理结果为 **拦截**，客户端会返回错误码：508，应用可根据错误码展示提示信息。

**消息拦截后客户端是否报错**：表示消息被拦截后，发送方是否要感知到消息发送失败

- **是**：（报错）服务在消息内容前面显示红色感叹号，提示发送方消息发送失败；
- （默认）**否**（不报错）：服务不提示消息发送失败。

3. 创建规则后，可以在规则列表中编辑或删除规则：

   ![](./images/moderation/moderation_rule_edit.png)

#### 文本或图片审核规则测试

下文以文本审核为例介绍如何进行审核规则测试：

1. 在即时通讯 IM 的左侧导航栏中选择**文本审核** > **规则测试**，进入文本审核规则测试页面。

![](./images/moderation/moderation_rule_test.png)

2.选择审核规则，填写要审核的内容，点击 **立即审核** 进行规则测试，审核结果和消息处理结果会显示在页面下方。

### 消息内容审核 - 名单过滤

名单服务是根据用户配置的词条名单进行消息内容过滤的服务。消息处理的行为支持配置为拦截消息和替换为 ***。

#### 名单设置

1. 在声网控制台中依次点击左侧导航栏的 **项目管理** > 对应项目的 **配置** 按钮 > 即时通讯 IM 的 **配置** 按钮 > 左侧二级导航栏的 **名单管理**，进入名单管理页面；

   ![关键字_zh](https://web-cdn.agora.io/docs-files/1656313419195)

2.在名单管理页面中可以增加和删除名单以及设置含有相应名单的消息的处理策略，包括用 *** 替换该词或拒绝下发消息。

### 消息内容审核 - 域名过滤

域名过滤服务是根据用户配置的域名进行消息内容过滤的服务。

参考以下步骤设置域名过滤审核规则：

1.在声网控制台中依次点击左侧导航栏的 **项目管理** > 对应项目的 **配置** 按钮 > 即时通讯 IM 的 **配置** 按钮 > 左侧二级导航栏的 **域名过滤**，进入域名过滤页面：

   ![domain_en](https://web-cdn.agora.io/docs-files/1656313436703)

2. 要创建域过滤规则，请单击**添加**：

   ![domain_rule_en](https://web-cdn.agora.io/docs-files/1656313449970)

2. 点击 **添加规则** 按钮进行域名过滤规则的创建。规则的字段介绍如下：

|字段|描述|
|------|------|
|审核名称|审核规则的名称，用于区分不同规则。|
|审核目标|审核目标指的是审核规则生效的范围，包括：单聊、群聊、聊天室、一组群 ID、一组聊天室 ID。当具体群组或聊天室设置了规则后，则不执行群组或聊天室全局的过滤规则。|
|审核开关|审核规则的开关状态，打开后规则生效，关闭则规则不生效。|
|消息处理策略|<li>拦截包含域名的消息；<li>只允许包含域名的消息通过；<li>消息中的域名替换为 ***；<li>不处理。|
|添加域名|为规则中添加域名。|
|用户管理 |对一段时间内达到违规限制的用户进行处理。审核处罚包括：封禁用户、强制用户下线或删除用户。 |

3. 创建规则后，在规则列表中可以进行规则的 **编辑** 和 **删除** 操作：

   ![domain_rule_edit_en](https://web-cdn.agora.io/docs-files/1656313466023)

### 查看审核历史记录

你可以在声网控制台查看文本、图片和音视频审核的记录。下文以文本审核为例进行介绍。

在即时通讯 IM 的左侧导航栏中选择**文本审核** > **历史记录**，进入文本审核历史记录页面。审核历史记录支持按照时间段、会话类型、风险类型、消息处置结果进行筛选。你也可以指定发送方或接收方的用户 ID 查询审核历史记录。

![](./images/moderation/moderation_history.png)


<a name="usermanagement"></a>

## 用户管理

发现违规行为后，对于违规用户可以进行多种限制操作，包括 app 级别和单聊的用户管理、群组成员管理和聊天室成员管理。

<table>
   <tr>
      <td>分类</td>
      <td>功能</td>
      <td>描述</td>
   </tr>
   <tr>
      <td rowspan="3">App 级别和单聊的用户管理</td>
      <td>用户封禁</td>
      <td>禁用一个用户账户。禁用后，该用户会立即下线，且无法登录直到解除封禁。</td>
   <tr>
      <td>强制下线</td>
      <td>强制用户下线，进入离线状态。被强制下线的用户需要重新登录才能正常使用即时通讯 IM 服务。</td>
   <tr>
      <td>删除用户</td>
      <td>该用户账号信息将被删除。如果被删除的用户是群组或者聊天室的所有者，该用户所管理的群组和聊天室也会相应被删除。</td>
    </tr>
    <tr>
      <td rowspan="4">群组成员管理</td>
      <td>群组用户禁言</td>
      <td>群组禁言是指禁止指定群组用户在群组中发送消息。被禁言用户直到禁言状态被解除，才能发送消息。</td>
   <tr>
      <td>群组全局禁言</td>
      <td>全局禁言是指禁止群组全部用户在群组中发送消息。被禁言的群组直到禁言状态被解除，群中成员才能发送消息。</td>
   <tr>
      <td>群组黑名单</td>
      <td>被加入到群组黑名单的用户将被移出群，并且不能再次加入。</td>
   <tr>
      <td>删除群成员</td>
      <td>删除群成员是指把用户从群成员列表中删除，被删除的用户需要重新加入群才能收到群消息。</td>
    </tr>
    <tr>
      <td rowspan="4">聊天室成员管理</td>
      <td>聊天室成员禁言</td>
      <td>聊天室禁言是指禁止指定成员在聊天室中发送消息。被禁言用户直到禁言状态被解除，才能发送消息</td>
   <tr>
      <td>聊天室全局禁言</td>
      <td>全局禁言是指禁止聊天室全部用户在聊天室中发送消息。被禁言的聊天室直到禁言状态被解除，聊天室中成员才能发送消息。</td>
   <tr>
      <td>聊天室黑名单</td>
      <td>被加入到聊天室黑名单列表的用户将被移出聊天室，并且不能再次加入。</td>
   <tr>
      <td>删除聊天室成员</td>
      <td>删除聊天室成员是指把用户从聊天室成员列表中删除，被删除的用户需要重新加入聊天室才能收到聊天室消息。</td>
   <tr>
</table>

### 用户管理

App 级别和单聊的用户管理如下：

1. 在声网控制台的即时通讯 IM 的左侧导航栏中选择**运营管理** > **用户**，进入用户管理页面。

   ![](./images/moderation/moderation_user_mgmt.png)

2. 搜索指定的用户 ID，在用户列表上点击**操作**一栏中的的 **更多**，可以对用户进行封禁、强制下线、删除操作。

 ![](./images/moderation/moderation_user_mgmt_action.png)

### 群组成员管理

1. 在声网控制台的即时通讯 IM 的左侧导航栏中选择**运营管理** > **群组**，进入群组成员管理页面。

    ![](./images/moderation/moderation_group.png)

2. 搜索指定的群组 ID，在群组列表中点击**操作**一栏中的**更多**，可以删除群组。

   ![](./images/moderation/moderation_group_mgmt.png)

3. 在群组列表中点击群组 ID，进入该群组的实时审核页面。在该页面中，可以对群组信息、群组成员和群组中的消息进行实时管理。

群成员管理包括添加和删除群成员、将群成员加入禁言列表和黑名单、全员禁言以及添加和删除群管理员。

   ![](./images/moderation/moderation_group_realtime.png)

   > 要使用此功能，需要在 **功能配置** > **总览** 页面上启用实时审核功能。

   ![](./images/moderation/moderation_realtime.png)

### 聊天室成员管理

1. 在声网控制台的即时通讯 IM 的左侧导航栏中选择**运营管理** > **聊天室**，进入聊天室成员管理页面。

   ![](./images/moderation/moderation_room.png)

2. 搜索指定的聊天室 ID，在聊天室列表中点击**操作**一栏中的**更多**，可以删除聊天室。

   ![](./images/moderation/moderation_room_mgmt.png)

3.在聊天室列表中点击聊天室 ID，进入该聊天室的实时审核页面。在该页面中，可以对聊天室的信息、聊天室成员和聊天室中的消息进行实时管理。

聊天室成员管理包括添加和删除聊天室成员、将聊天室成员加入禁言列表和黑名单、全员禁言以及添加和删除聊天室管理员。

   ![](./images/moderation/moderation_room_realtime.png)

   > 要使用此功能，需要在 **功能配置** > **总览** 页面上启用实时审核功能。

  ![](./images/moderation/moderation_realtime.png)
