---
title: 使用云代理服务
platform: Linux
updatedAt: 2020-06-22 16:37:38
---
## 功能简介
对于安全需求较高的企业用户，设置防火墙可以限制员工访问非认可的网站，保护内部信息安全。

为避免这些企业因防火墙无法使用 Agora 的服务，Agora 开发了云代理服务。用户只需要在防火墙上将特定的 IP 及端口列入白名单，就可以实现内网访问 Agora 服务。

相比配置单一的代理服务器的 IP，云代理服务更灵活稳定，因此在大型企业、医院、高校、金融等安全需求较高的机构内都有广泛的应用。

## 实现方法
<div class="note alert">Agora 本地服务端录制 SDK v3.0.0 及以上版本支持云代理服务，使用云代理服务前请确保你已经下载并集成本地服务端录制 SDK v3.0.0 及以上版本。</div>

根据以下步骤使用云代理服务：

1. 联系 [sales@agora.io](mailto:support@agora.io) 申请开通云代理服务，并提供以下信息：

   - 代理服务使用区域。
   - 并发规模。
   - 网络运营商。

2. 将以下测试 IP 及端口添加到企业防火墙的白名单。

   源地址为集成了 Agora Native/On-premise Recording SDK 的客户端。
 
| 协议 | 目标地址      | 端口                    | 端口用途     |
| ---- | ------------- | ----------------------- | ------------ |
| TCP  | 120.92.118.34 | 4000                    | 消息数据传输 |
| TCP  | 120.92.18.162 | 4000                    | 消息数据传输 |
| TCP  | 47.74.211.17  | 1080, 8000, 25000, 9700 | 边缘节点通信 |
| TCP  | 52.80.192.229 | 1080, 8000, 25000, 9700 | 边缘节点通信 |
| TCP  | 52.52.84.170  | 1080, 8000, 25000, 9700 | 边缘节点通信 |
| TCP  | 47.96.234.219 | 1080, 8000, 25000, 9700 | 边缘节点通信 |
| UDP  | 120.92.118.34 | 4500 - 4650             | 媒体数据交换 |
| UDP  | 120.92.18.162 | 4500 - 4650             | 媒体数据交换 |
| UDP  | 47.74.211.17  | 1080, 8000, 25000, 9700 | 边缘节点通信 |
| UDP  | 52.80.192.229 | 1080, 8000, 25000, 9700 | 边缘节点通信 |
| UDP  | 52.52.84.170  | 1080, 8000, 25000, 9700 | 边缘节点通信 |
| UDP  | 47.96.234.219 | 1080, 8000, 25000, 9700 | 边缘节点通信 |
	 
<div class="alert note">以上 IP 仅供测试阶段调试使用，正式上线前需要向 Agora 申请独立的云代理服务资源。</div>

3. 录制端加入频道时在 `RecordingConfig` 中将 `enableCloudProxy` 参数设为 `true`，声网会自动配置默认的代理服务器域名，开启云代理服务。当默认的代理服务器域名无法解析时，可通过以下方式直接配置 IP 列表和端口：

   1. `RecordingConfig` 中的 `proxyType` 参数设为 2。
   2. `RecordingConfig` 中的 `proxyServer` 参数设为 `"47.74.211.17,52.80.192.229,52.52.84.170,47.96.234.219:0"`。

> 如果你使用命令行 demo 录制，在开始录制时设置 `--enableCloudProxy 1 --proxyType ${type} --proxyServer ${ip,port}`。

4. 测试完成后，Agora 会为你部署云代理服务正式环境，并提供相应的 IP 和端口。将 Agora 提供的 IP 和端口添加到企业防火墙的白名单。

## 工作原理

Agora 云代理的工作原理如下：
![](https://web-cdn.agora.io/docs-files/1569400362511)

1. Agora SDK 在连接 Agora SD-RTN 之前，向云代理发起请求；

3. 云代理发送相应代理信息；
4. Agora SDK 向云代理发送数据，云代理将接收到的数据透传给 Agora SD-RTN；
5. Agora SD-RTN 向云代理返回数据，云代理再将接收到的数据发送给 Agora SDK。