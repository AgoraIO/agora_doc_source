本文介绍使用云端录制 RESTful API 进行页面录制以及页面录制并推流到 CDN的重点步骤。建议你同时参考[云端录制 RESTful API 快速开始](https://docs.agora.io/cn/cloud-recording/cloud_recording_rest)了解云端录制的基础流程。

## 功能描述

云端录制共支持三种录制模式：

- 单流录制
- 合流录制
- 页面录制

页面录制模式下，录制服务将指定 URL 的页面内容和音频混合录制为一个音视频文件，如下图：

![](https://web-cdn.agora.io/docs-files/1604990307461)

你可以使用页面录制还原在线课堂、视频会议等场景的完整体验。举例来说，当一个 Web 应用集成了声网 SDK 以及声网互动白板 SDK，页面录制可以录制页面内的全部元素，而不仅限于音视频流。

![](https://web-cdn.agora.io/docs-files/1604990333415)

页面录制模式下，你还可以在录制的过程中，将页面的内容和音频转化为一路音视频流，并推送到 CDN，如下图：

![](https://web-cdn.agora.io/docs-files/1640245675669)

## 前提条件

页面录制需满足以下前提条件：

- 如果你需要同时使用页面录制和云端录制的其他功能，例如单流录制或截图，建议页面录制使用单独的 App ID，与其他业务的请求进行区分，便于声网对页面录制进行独立的资源管理。
- 你需要提供一个能通过 URL 访问的 Web 应用，作为待录制的内容源。（其他主播和观众可以使用该 Web 应用，也可以使用其他平台的应用。）
- 你的 Web 应用需要兼容 Chrome 浏览器。
- 由于云端录制仅录制浏览器窗口可见部分，该 Web 页面需要全部可见，即无需滚动条。
- 如需还原主播端看到的全部内容，你需要将主播端的操作同步到应用中。


## 实现页面录制

参考以下步骤，实现页面录制。

### 获取录制资源

在开始录制前，必须调用 [`acquire`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_acquire?platform=RESTful) 方法请求一个用于云端录制的 resource ID。
你需要将 `scene` 参数设置为 `1`，即分配页面录制资源；`resourceExpiredHour` 为 RESTful API 的调用时效，取值范围 [1,720]，默认值为 72。具体参数说明详见 [获取录制资源 API 参考](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_acquire?platform=RESTful#http-请求)。

> 超时后录制不会自动停止，最大录制时长为你通过 `start` 方法中的 `maxRecordingHour` 参数设置的值。

#### 请求示例

- 请求 URL：
```
https://api.agora.io/v1/apps/{yourappid}/cloud_recording/acquire
```

- `Content-type` 为 `application/json;charset=utf-8`
- `Authorization` 为 Basic authorization，生成方法请参考 [RESTful API 认证](https://docs.agora.io/cn/faq/restful_authentication)。
- 请求包体内容：

```json
{
    "cname": "httpClient463224",
    "uid": "527841",
    "clientRequest": {
        "resourceExpiredHour": 24,
        "scene": 1
    }
}
```

### 开始录制

在调用 [`start`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful)方法时，将 `mode` 参数设置为 `web`，启用[页面录制模式](https://docs.agora.io/cn/Agora%20Platform/webpage_recording)。该模式下，你还需要通过 `extensionServiceConfig` 设置页面录制的详细信息，以及通过 `storageConfig` 设置第三方云存储的信息。

<div class="alert note">录制模式的设置必须在开始录制的时候完成，不支持在录制开始后切换模式。</div>

页面录制支持的 `clientRequest` 参数包括：

| 参数                     | 配置内容     | 是否选填 |
| :----------------------- | :----------- | :------- |
| [`recordingFileConfig`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful#录制文件设置)    | 录制文件     | 选填     |
| [`storageConfig`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful#云存储设置)          | 第三方云存储 | 必填     |
| [`extensionServiceConfig`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful#扩展服务设置) | 扩展服务设置     | 必填     |
| `extensionServiceConfig.extensionServices[]`| 如果要进行页面录制，你需要将 `serviceName` 其设置为 "`web_recorder_service`"。 | 必填     |

请求示例

- 请求 URL：
```
https://api.agora.io/v1/apps/{yourappid}/cloud_recording/resourceid/{resourceid}/mode/web/start
```

- `Content-type` 为 `application/json;charset=utf-8`
- `Authorization` 为 Basic authorization，生成方法请参考 [RESTful API 认证](https://docs.agora.io/cn/faq/restful_authentication)。

请求包体内容：
```json
{
    "cname": "httpClient463224",
    "uid": "527841",
    "clientRequest": {
        "token": "<token if any>",
        "extensionServiceConfig": {
            "errorHandlePolicy": "error_abort",
            "extensionServices": [
                {
                    "serviceName": "web_recorder_service",
                    "errorHandlePolicy": "error_abort",
                    "serviceParam": {
                        "url": "https://xxxxx",
                        "audioProfile": 0,
                        "videoWidth": 1280,
                        "videoHeight": 720,
                        "maxRecordingHour": 3
                    }
                }
            ]
        },
        "recordingFileConfig": {
            "avFileType": [
                "hls",
                "mp4"
            ]
        },
        "storageConfig": {
            "vendor": 2,
            "region": 3,
            "bucket": "xxxxx",
            "accessKey": "xxxxx",
            "secretKey": "xxxxx",
            "fileNamePrefix": [
                "directory1",
                "directory2"
            ]
        }
    }
}
```

### 停止录制

录制完成后，调用 [`stop`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_stop?platform=RESTful) 方法离开频道，停止录制。录制停止后如需再次录制，必须再调用 `acquire` 方法请求一个新的 resource ID。

<div class="alert note">页面录制停止前会持续计费，请根据实际业务情况设置合理的 <code>maxRecordingHour</code>，或主动停止页面录制。</div>

#### 请求示例

- 请求 URL：
```
https://api.agora.io/v1/apps/{yourappid}/cloud_recording/resourceid/{resourceid}/sid/{sid}/mode/web/stop
```

- `Content-type` 为 `application/json;charset=utf-8`
- `Authorization` 为 Basic authorization，生成方法请参考 [RESTful API 认证](https://docs.agora.io/cn/faq/restful_authentication)。
- 请求包体内容：

```json
{
    "cname": "httpClient463224",
    "uid": "527841",
    "clientRequest": {}
}
```

#### 响应示例
```json
"Code": 200,
"Body":
{
    "resourceId": "JyvK8nXHuV1BE64GDkAaBGEscvtHW7v8BrQoRPCHxmeVxwY22-x-kv4GdPcjZeMzoCBUCOr9q-k6wBWMC7SaAkZ_4nO3JLqYwM1bL1n6wKnnD9EC9waxJboci9KUz2WZ4YJrmcJmA7xWkzs_L3AnNwdtcI1kr_u1cWFmi9BWAWAlNd7S7gfoGuH0tGi6CNaOomvr7-ILjPXdCYwgty1hwT6tbAuaW1eqR0kOYTO0Z1SobpBxu1czSFh1GbzGvTZG",
    "sid": "38f8e3cfdc474cd56fc1ceba380d7e1a",
    "serverResponse": {
        "extensionServiceState": [
            {
                "payload": {
                    "fileList": [
                        {
                            "filename": "a836026b2d4e3b276ba0de9f51a16f41_QIBO.m3u8",
                            "sliceStartTime": 1625663059301
                        },
                        {
                            "filename": "a836026b2d4e3b276ba0de9f51a16f41_QIBO_0.mp4",
                            "sliceStartTime": 1625663059301
                        }
                    ],
                    "state": "exit"
                },
                "serviceName": "web_recorder_service"
            },
            {
                "payload": {
                    "uploadingStatus": "uploaded"
                },
                "serviceName": "upload_service"
            }
        ]
    }
}
```

## 实现页面录制并推流到 CDN

参考以下步骤，实现页面录制并推流到 CDN。

### 获取 resource ID

在开始页面录制并推流到 CDN 前，必须调用 [`acquire`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_acquire?platform=RESTful) 方法请求一个用于云端录制的 resource ID。你需要将 `scene` 参数设置为 `1`，即分配页面录制资源。

#### 请求示例

- 请求 URL：
```
https://api.agora.io/v1/apps/{yourappid}/cloud_recording/acquire
```

- `Content-type` 为 `application/json;charset=utf-8`
- `Authorization` 为 Basic authorization，生成方法请参考 [RESTful API 认证](https://docs.agora.io/cn/faq/restful_authentication)。
- 请求包体内容：

```json
{
    "cname": "httpClient463224",
    "uid": "527841",
    "clientRequest": {
        "resourceExpiredHour": 24,
        "scene": 1
    }
}
```

### 开始页面录制并推流到 CDN

在调用 [`start`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful) 方法时，将 `mode` 参数设置为 `web`，启用[页面录制模式](https://docs.agora.io/cn/Agora%20Platform/webpage_recording)。该模式下，你还需要通过 `extensionServiceConfig` 设置页面录制和推流到 CDN 的详细信息，以及通过 `storageConfig` 设置第三方云存储的信息。

<div class="alert note">录制模式的设置必须在开始录制的时候完成，不支持在录制开始后切换模式。</div>

页面录制并推流到 CDN 支持的 `clientRequest` 参数包括：

| 参数                     | 配置内容     | 是否选填 |
| :----------------------- | :----------- | :------- |
| [`recordingFileConfig`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful#录制文件设置)    | 录制文件     | 选填     |
| [`storageConfig`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful#云存储设置)          | 第三方云存储 | 必填     |
| [`extensionServiceConfig`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_start?platform=RESTful#扩展服务设置) | 扩展服务设置     | 必填     |
| `extensionServiceConfig.extensionServices[]`| 如果要进行页面录制并推流到 CDN，你需要分别将 `serviceName` 设置为 "`web_recorder_service`"（页面录制） 和 "`rtmp_publish_service`"（推流到 CDN），并设置页面录制和推流到 CDN 相关参数。 | 必填     |

请求示例

- 请求 URL：
```
https://api.agora.io/v1/apps/{yourappid}/cloud_recording/resourceid/{resourceid}/mode/web/start
```

- `Content-type` 为 `application/json;charset=utf-8`
- `Authorization` 为 Basic authorization，生成方法请参考 [RESTful API 认证](https://docs.agora.io/cn/faq/restful_authentication)。

请求包体内容：
```json
{
    "cname": "httpClient463224",
    "uid": "527841",
    "clientRequest": {
        "token": "<token>",
        "extensionServiceConfig": {
            "extensionServices": [
                {
                    "serviceName": "web_recorder_service",
                    "errorHandlePolicy": "error_abort",
                    "serviceParam": {
                        "url": "https://xxxxx",
                        "audioProfile": 0,
                        "videoWidth": 1280,
                        "videoHeight": 720,
                        "maxRecordingHour": 3,
                        "maxVideoDuration": 200
                    }
                },
                {
                    "serviceName": "rtmp_publish_service",
                    "errorHandlePolicy": "error_ignore",
                    "serviceParam": {
                        "outputs": [
                            {
                                "rtmpUrl": "rtmp://xxx"
                            }
                        ]
                    }
                }
            ]
        },
        "recordingFileConfig": {
            "avFileType": [
                "hls",
                "mp4"
            ]
        },
        "storageConfig": {
            "vendor": 2,
            "region": 3,
            "bucket": "xxxxx",
            "accessKey": "xxxxx",
            "secretKey": "xxxxx",
            "fileNamePrefix": [
                "directory1",
                "directory2"
            ]
        }
    }
}
```

### 停止页面录制以及推流到 CDN

录制及推流完成后，调用 [`stop`](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_stop?platform=RESTful) 方法离开频道，停止录制及推流。录制进程停止后如需再次录制，必须再调用 `acquire` 方法请求一个新的 resource ID。

#### 请求示例

- 请求 URL：
```
https://api.agora.io/v1/apps/{yourappid}/cloud_recording/resourceid/{resourceid}/sid/{sid}/mode/web/stop
```

- `Content-type` 为 `application/json;charset=utf-8`
- `Authorization` 为 Basic authorization，生成方法请参考 [RESTful API 认证](https://docs.agora.io/cn/faq/restful_authentication)。
- 请求包体内容：

```json
{
    "cname": "httpClient463224",
    "uid": "527841",
    "clientRequest": {}
}
```

#### 响应示例
```json
"Code": 200,
"Body":
{
    "resourceId": "JyvK8nXHuV1BE64GDkAaBGEscvtHW7v8BrQoRPCHxmeVxwY22-x-kv4GdPcjZeMzoCBUCOr9q-k6wBWMC7SaAkZ_4nO3JLqYwM1bL1n6wKnnD9EC9waxJboci9KUz2WZ4YJrmcJmA7xWkzs_L3AnNwdtcI1kr_u1cWFmi9BWAWAlNd7S7gfoGuH0tGi6CNaOomvr7-ILjPXdCYwgty1hwT6tbAuaW1eqR0kOYTO0Z1SobpBxu1czSFh1GbzGvTZG",
    "sid": "38f8e3cfdc474cd56fc1ceba380d7e1a",
    "serverResponse": {
        "extensionServiceState": [
            {
                "payload": {
                    "fileList": [
                        {
                            "filename": "a836026b2d4e3b276ba0de9f51a16f41_QIBO.m3u8",
                            "sliceStartTime": 1625663059301
                        },
                        {
                            "filename": "a836026b2d4e3b276ba0de9f51a16f41_QIBO_0.mp4",
                            "sliceStartTime": 1625663059301
                        }
                    ],
                    "state": "exit"
                },
                "serviceName": "web_recorder_service"
            },
            {
                "payload": {
                    "state": "onhold"
                },
                "serviceName": "rtmp_publish_service"
            },
            {
                "payload": {
                    "uploadingStatus": "uploaded"
                },
                "serviceName": "upload_service"
            }
        ]
    }
}
```
响应包体中的参数说明详见[页面录制并推流到 CDN](https://docs.agora.io/cn/cloud-recording/cloud_recording_api_stop?platform=RESTful#页面录制并推流到-cdn)。

## 录制生成文件

录制后共生成一个 M3U8 文件和多个 TS 文件。根据 `avFileType` 参数的设置，还有可能生成一个或多个 MP4 文件。录制文件的命名规则详见[管理录制文件](https://docs.agora.io/cn/cloud-recording/cloud_recording_manage_files)。

## 计费
页面录制自 2021 年 11 月 1 日起开始收费，详见<a href="https://docs.agora.io/cn/cloud-recording/billing_cloud_recording_web?platform=RESTful">页面录制计费说明</a>。

## 开发注意事项
### 针对 Web 应用的限制
- 待录制页面中任一视频源的分辨率都不得超过 1920 × 1080。
- 页面录制生成的视频分辨率最高为 1920 × 1080。
- 待录制页面不得使用 WebGL 功能。
- 待录制页面的下行带宽不得超过 10 Mbps，上行带宽不得超过 2 Mbps。
- 请尽量避免你的 Web 应用占用过多的 CPU 内存和带宽，且该 Web 应用的使用目的应合法合规。
- 页面录制支持 video 元素启用了 autoplay 属性后在无用户交互状态下自动播放。但如果待录制页面中的 video 元素未启用 autoplay 属性，其内容将不会自动播放，这将会导致页面录制无法录制到该视频。
- 待录制页面不得跳转至不同域名的 URL，同时尽量避免其他任何形式的跳转。如待录制页面需登录操作，需先自行处理登录操作，再进行录制。
- 你可以使用[页面加载超时检测功能](https://docs.agora.io/cn/cloud-recording/cloud_recording_webpage_load_timeout?platform=RESTful)，来避免页面加载超时导致的录制内容与预期不一致的问题。

### RESTful API 请求
- 从发起请求到开始页面录制，有 5s 左右的延时。建议提前发起录制请求，以保证录制内容完整。
- 页面录制不支持 `updateLayout` 方法。
- 如果你在 `start` 方法中填入的 URL 无法正常打开，录制服务会在 `start` 成功后自动退出。你可以参考<a name="确认录制服务已成功启动"></a>[云端录制集成最佳实践](https://docs.agora.io/cn/cloud-recording/integration_best_practices?platform=RESTful#a-namestart_successa确认录制服务已成功启动)，使用退避策略多次调用 `query`，来确认录制服务正常启动。
- 如果页面录制服务或录制上传服务异常，则导致推流到 CDN 失败；如果推流到 CDN 异常，页面录制不受影响。

### 其他
- 录制过程中，录制服务会在当前 MP4 文件时长超过约 `maxVideoDuration` 的值或大小超过约 2 GB 左右时创建一个新的 MP4 文件。
- 如果你在 `start` 方法中填入待录制页面的 URL 会自动触发 Web 客户端发布音视频流，录制服务也会成为一个发流端，因此，你的应用中可能会出现一个绿色背景色的用户画面。
	 为规避该问题，你可以在待录制页面的 URL 中增加查询参数 `is_recorder=1`，例如："https://url?is_recorder=1 "，并在该页面内添加以下逻辑：
	 - 如果 `is_recorder` 为 1，则 Web 客户端不发布音视频流。
	 - 如果 `is_recorder` 不为 1，则 Web 客户端发布音视频流。
- 进行页面录制时，录制服务相当于一个使用 Web 应用的客户端，因此，如果你的 Web 应用包含用户列表，建议你在用户列表中隐藏该用户。