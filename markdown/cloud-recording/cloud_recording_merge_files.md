---
title: 合并单流录制获得的音频和视频文件
platform: All Platforms
updatedAt: 2021-02-20 09:11:09
---
## 功能描述

单流录制模式下，每个 UID 的音频和视频均分开录制，每个 UID 都有其对应的音频文件和视频文件。你可以使用我们的音视频合并转码脚本，合并每个 UID 的音频文件和视频文件。

## 前提条件

### 环境准备

以下物理或虚拟服务器：

- Ubuntu 14.04+ x64
- CentOS 6.5+（推荐 7.0）x64

安装 Python 2.7 及以上版本

### 录制文件准备

- 确保你已经使用 Agora 云端录制 RESTful API 在单流录制模式下生成录制文件。
- 确保你已经将生成的录制文件下载到本地。任何一个录制文件的缺失都将导致转码失败。
- 确保录制文件夹内有 `recording2-done.txt` 文件，标识本频道录制结束。

## 转码步骤

### 1.获取音视频合并转码脚本

下载 [Agora 云端录制转码脚本](https://download.agora.io/acrsdk/release/Agora_Cloud_Recording_Tools_v1.0.0.7_20190929-1569690666_807.tar.gz) 压缩包并解压。在 `tools` 文件夹下找到 `convert.py` 文件。

### 2.设置转码参数

解压完成后，设置转码参数后即可开始转码。

#### 转码参数介绍

你可先如下图所示，输入命令行 `python convert.py`，查看转码参数介绍。

![](https://web-cdn.agora.io/docs-files/1568872206603)

也可通过下列表格了解各参数。

| 参数 | 描述                                                         |
| :--- | :----------------------------------------------------------- |
| `-f` | 指定待转码文件的存储路径。如该路径中有多次录制产生的录制文件，转码脚本会对所有的录制文件依次进行转码。 |
| `-m` | 设置转码模式。详见下文 [`-m` 参数介绍](#-m)。<li>`0`：默认转码模式，按 segment 转码，即把同一个 segment 的音频和视频合成一个音视频文件。</li><li>`1`：音视频合并模式。</li><li>`2`：音频合并模式。</li><li>`3`：视频合并模式。</li> |
| `-s` | 设置保存模式，表示转码是否需要严格时间同步，即用户离开频道的时间是否占转码文件时长：<li>`0`：默认为 `all time recording` 模式。此模式下，如果用户录制中途退出频道后重新加入，用户退出的时间会以黑色的画面呈现在录制文件里。举例来说，用户在频道里 2 分钟后，退出频道 30 分钟，再加入频道 2 分钟，则录制文件长度最终为 34 分钟，其中 30 分钟为黑屏。</li><li>`1`：转码文件中删除用户中途退出频道到重新加入频道之间的黑屏时长。</li> 此参数仅 `-m` 设为 `1`，`2` 或 `3` 时有效。|
| `-p` | 设置转码后视频的帧率，单位为 fps。默认值为 15 fps。取值范围为 5 fps 到 120 fps。如果设置低于 5 fps，则按 5 fps 执行。具体设置请参考[分辨率、帧率、码率对照表](https://docs.agora.io/cn/faq/recording_video_profile#分辨率、帧率、码率对照表)。 |
| `-r` | 设置转码后视频的分辨率，格式为“宽 高”，例如 `-r 640 360`。具体设置请参考[分辨率、帧率、码率对照表](https://docs.agora.io/cn/faq/recording_video_profile#分辨率、帧率、码率对照表)。 |

<a name="-m"></a>**-m 参数介绍**

在了解 `-m` 参数之前，你需要先了解录制 segment 的概念。录制 segment 指每个 UID 从开始录制到结束录制这一过程。

一个 UID 开始录制需同时满足以下两个条件：

- 该 UID 加入频道并发流
- 开始云端录制

一个 UID 结束录制只需满足以下任一条件：

- 该 UID 停止发流且 15 秒内没有重新发流
- 该 UID 离开频道且 15 秒内没有重新加入
- 结束云端录制

了解录制 segment 的概念后，我们再来看 `-m` 参数不同设置的具体行为。

> 为方便起见，以下我们假设每个 UID 均生成多个音频文件和视频文件。

- `0`：把同一个 UID 的音频和视频按照录制 segment 合并。一个 UID 的一个录制 segment 对应一个音视频文件，文件名为 `UID_timestamp_av.mp4`。其中 `timestamp` 为服务器开始录制的时间，如音频和视频的开始时间不一致，`timestamp` 为两个开始时间中较早的时间。`timestamp` 的时区为 UTC+0，由年、月、日、小时、分钟、秒和毫秒组成。例如 `100_20190611073246073_av.mp4` 表示在 UTC 2019 年 6 月 11 日 7 点 32 分 46 秒 73 毫秒时开始录制的一个 UID 为 `100` 的用户的音视频文件。
- `1`：把同一个 UID 的音频和视频按时间顺序合成一个文件。一个 UID 对应一个音视频文件，文件名为 `UID_0_merge_av.mp4`。
- `2`：把同一个 UID 的音频按时间顺序合成一个文件。一个 UID 对应一个音频文件，文件名为 `UID_0_merge.m4a`。
- `3`：把同一个 UID 的视频按时间顺序合成一个文件。一个 UID 对应一个视频文件，文件名为 `UID_0_merge.mp4`。

#### 转码参数设置示例

下面结合具体案例来介绍 `-m` 参数的设置和最终得到的转码文件。

假设频道内有两个用户，UID 分别为 `100` 和 `123`。以单流模式开始云端录制。用户 `100` 曾离开频道，30 秒后再进入。因此得到的录制文件中，用户 `100` 有两个录制 segment，对应两个音频文件和两个视频文件，用户 `123` 对应一个音频文件和一个视频文件。

如想将每个 UID 的音视频合并成一个文件，可运行以下命令：

```
convert.py -f <待转码文件所在路径> -m 1 -s 1 -p 30 -r 640 360
```

最终会生成两个转码文件：`100_0_merge_av.mp4` 和 `123_0_merge_av.mp4`。UID `100` 用户退出频道后再进入频道之间的 30 秒时长不会包含在内。如要将 30 秒时长包含在内，需要将 `-s` 设置成 `0`。

如想将每个 UID 的音视频按照录制 segment 合并成一个文件，可运行以下命令：

```
convert.py -f <待转码文件所在路径> -m 0 -p 30 -r 640 360
```

最终会生成三个转码文件：`100_timestamp1_av.mp4`，`100_timestamp2_av.mp4`，和 `123_timestamp1_av.mp4`。

> 转码完成后，会生成一个 `convert-done.txt`，标志转码成功；还会生成一个 `convert.log `日志文件，和音视频文件在同一个目录下。

## 播放器支持

转码完成后的 MP4 文件几乎支持所有主流播放器，详见下表。

| 操作系统 | 支持播放器                                                   |
| :------- | :----------------------------------------------------------- |
| Linux    | <li>VLC</li><li>ffplayer</li>                                                  |
| Windows  | <li>Media Player</li><li>KM Player</li><li>VLC Player</li><li>Chrome (49.0.2623 及以后版本)</li>         |
| macOS    | <li>QuickTime Player</li><li>Movist</li><li>MPlayerX</li><li>Chrome (49.0.2623 及以后版本)</li><li>Safari (11.0.3 及以后版本)</li> |
| iOS      | <li>系统播放器</li><li>KMPlayer</li><li>Safari (9.0 及以后版本)</li>                             |
| Android  | <li>系统播放器</li><li>MXPlayer</li><li>VLC</li><li>KMPlayer</li><li>Chrome (49.0.2623 及以后版本)</li>           |

