<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE reference PUBLIC "-//OASIS//DTD DITA Reference//EN" "reference.dtd">
<reference id="callback_ivideoframeobserver_onpreencodevideoframe">
    <title><ph keyref="onPreEncodeVideoFrame"/></title>
    <shortdesc id="short"><ph id="shortdesc" props="cpp">Callback for pre-encoded video frames.</ph><ph id="shortdesc" props="android">Callback triggered each time the SDK receives a video frame before encoding.</ph></shortdesc>
    <prolog>
        <metadata>
            <keywords>
                <indexterm keyref="onPreEncodeVideoFrame"/>
            </keywords>
        </metadata>
    </prolog>
    <refbody>
        <section id="prototype">
            <p outputclass="codeblock">
                <codeblock props="cpp" outputclass="language-cpp">virtual bool onPreEncodeVideoFrame(agora::rtc::VIDEO_SOURCE_TYPE sourceType, VideoFrame&amp; videoFrame) = 0;</codeblock>
                <codeblock props="android" outputclass="language-java">@CalledByNative boolean onPreEncodeVideoFrame(int sourceType, VideoFrame videoFrame);</codeblock>
            </p>
        </section>
        <section id="detailed_desc" deliveryTarget="details" otherprops="no-title">
            <p props="cpp">After successfully registering the video frame observer, the SDK triggers this callback each time it receives a video frame. In this callback, you can obtain the video data before encoding and process it according to your scenario. After processing, you can return the processed video data to the SDK.</p>
            <p props="android">After you successfully register a video frame observer, the SDK triggers this callback each time it receives a video frame. In this callback, you can obtain the video data before encoding and process it according to your specific scenario. After processing, you can return the processed video data to the SDK.</p>
            <note props="cpp">
                <ul>
                    <li>If you want to send the preprocessed video data back to the SDK, you must call <xref keyref="getVideoFrameProcessMode"/> to set the video processing mode to read-write (<codeph>PROCESS_MODE_READ_WRITE</codeph>).</li>
                    <li>If you want to obtain the pre-encoded video data from the second screen capture source, you need to set the frame position to <codeph>POSITION_PRE_ENCODER</codeph> (1 &lt;&lt; 2) using <xref keyref="getObservedFramePosition"/>.</li>
                    <li>The video data obtained from this callback has already been preprocessed, including cropping, rotation, and beauty effects.</li>
                    <li>It is recommended to ensure that the modified parameters in <codeph>videoFrame</codeph> match the actual situation of the video frame in the buffer, otherwise rotation anomalies, image distortion, and other issues may occur in local preview and remote video display.</li>
                </ul>
            </note>
            <note props="android">
                <ul>
                    <li>If you want to send the preprocessed video data back to the SDK, you must first call <xref keyref="getVideoFrameProcessMode"/> to set the video processing mode to read-write (<codeph>PROCESS_MODE_READ_WRITE</codeph>).</li>
                    <li>To obtain pre-encoded video data from the second screen capture, you need to set the frame position to <codeph>VIDEO_MODULE_POSITION_PRE_ENCODER</codeph> (1 &lt;&lt; 2) via <xref keyref="getObservedFramePosition"/>.</li>
                    <li>The video data obtained from this callback has already been preprocessed, including cropping, rotation, and beauty effects.</li>
                    <li>It is recommended to ensure that the modified parameters in <codeph>videoFrame</codeph> match the actual video frame in the buffer. Otherwise, issues such as abnormal rotation or image stretching may occur in local preview and remote video display.</li>
                </ul>
            </note>
        </section>
        <section id="timing" deliveryTarget="details" props="android cpp">
            <title>Trigger Timing</title>
            <p props="cpp">Triggered when the SDK receives a video frame before encoding.</p>
            <p props="android">This callback is triggered each time the SDK receives a video frame before encoding.</p>
        </section>
        <section id="parameters" deliveryTarget="details" props="android cpp">
            <title>Parameters</title>
            <parml>
                <plentry props="cpp">
                    <pt>sourceType</pt>
                    <pd>Video source type. See <xref keyref="VIDEO_SOURCE_TYPE"/>.</pd>
                </plentry>
                <plentry props="cpp">
                    <pt>videoFrame</pt>
                    <pd>Output parameter representing the video frame before encoding. See <xref keyref="VideoFrame"/>.
                        <note>The default format of video frame data obtained through this callback is as follows:
                            <ul>
                                <li>Android: I420 or RGB (<codeph>GLES20.GL_TEXTURE_2D</codeph>).</li>
                                <li>iOS: I420 or <codeph>CVPixelBufferRef</codeph>.</li>
                                <li>macOS: I420 or <codeph>CVPixelBufferRef</codeph>.</li>
                                <li>Windows: YUV420.</li>
                            </ul>
                        </note>
                    </pd>
                </plentry>
                <plentry props="android">
                    <pt>sourceType</pt>
                    <pd>Video source type. See <xref keyref="VIDEO_SOURCE_TYPE"/>.</pd>
                </plentry>
                <plentry props="android">
                    <pt>videoFrame</pt>
                    <pd>Video frame.
                        <note>The default format of the video frame data obtained through this callback is as follows:
                            <ul>
                                <li>Android: I420 or RGB (<codeph>GLES20.GL_TEXTURE_2D</codeph>).</li>
                            </ul>
                        </note>
                    </pd>
                </plentry>
            </parml>
        </section>
        <section id="return_values" props="android cpp">
            <title>Return Values</title>
            <p props="cpp">
                <ul>
                    <li>When the video processing mode is <codeph>PROCESS_MODE_READ_ONLY</codeph>:
                        <ul>
                            <li><xref keyref="true"/>: Retain for further use.</li>
                            <li><xref keyref="false"/>: Retain for further use.</li>
                        </ul>
                    </li>
                    <li>When the video processing mode is <codeph>PROCESS_MODE_READ_WRITE</codeph>:
                        <ul>
                            <li><xref keyref="true"/>: Instructs the SDK to accept the video frame.</li>
                            <li><xref keyref="false"/>: Instructs the SDK to discard the video frame.</li>
                        </ul>
                    </li>
                </ul>
            </p>
            <p props="android">
                <ul>
                    <li>When the video processing mode is <codeph>PROCESS_MODE_READ_ONLY</codeph>:
                        <ul>
                            <li><xref keyref="true"/>: Retain for subsequent use.</li>
                            <li><xref keyref="false"/>: Retain for subsequent use.</li>
                        </ul>
                    </li>
                    <li>When the video processing mode is <codeph>PROCESS_MODE_READ_WRITE</codeph>:
                        <ul>
                            <li><xref keyref="true"/>: The SDK accepts the video frame.</li>
                            <li><xref keyref="false"/>: The SDK discards the video frame.</li>
                        </ul>
                    </li>
                </ul>
            </p>
        </section>
    </refbody>
</reference>