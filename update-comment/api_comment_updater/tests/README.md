# 回归测试文档

## 概述

本目录包含了API注释注入工具的回归测试脚本，用于确保代码重构和功能更新不会破坏现有功能。

## 文件结构

```
tests/
├── README.md                    # 本文档
├── cpp_regression_test.py       # C++回归测试脚本
├── cpp_regression_test.json     # C++测试专用JSON配置
├── run_cpp_regression.py        # C++回归测试快速运行脚本
├── test_original.h              # 原始测试文件（基准）
├── test_expected_output.h       # 期望输出文件（可选）
└── src/                         # 测试源码目录
    └── test.h                   # 当前测试文件
```

## C++回归测试

### 快速运行

```bash
# 方法1: 直接运行测试脚本
python tests/cpp_regression_test.py

# 方法2: 使用快速运行脚本
python tests/run_cpp_regression.py
```

### 测试内容

C++回归测试会验证以下功能：

1. **API注释注入**: 验证`adjustUserPlaybackSignalVolume`方法的注释注入
2. **类注释注入**: 验证`ScreenAudioParameters`结构体的注释注入
3. **属性注释注入**: 验证类属性（`sampleRate`, `channels`, `captureSignalVolume`）的注释注入
4. **枚举注释注入**: 验证`AUDIENCE_LATENCY_LEVEL_TYPE`枚举的注释注入
5. **枚举值注释注入**: 验证枚举值的注释注入

### 测试流程

1. **环境设置**: 备份当前测试文件，复制原始测试文件
2. **注释注入**: 运行注释注入命令
3. **结果分析**: 解析注入日志，统计成功/失败数量
4. **内容验证**: 检查注入后的文件内容是否包含期望的注释
5. **期望比较**: 与期望输出文件比较（如果存在）
6. **环境清理**: 恢复原始测试文件

### 测试配置

- **测试文件**: `test_original.h` → `src/test.h`
- **JSON配置**: `cpp_regression_test.json`
- **平台**: `cpp-ng`

### 成功标准

- 所有API、类、枚举注释注入成功
- 注入的注释内容包含期望的关键文本
- 注释块数量符合预期
- 无异常或错误发生

## 添加新的回归测试

### 为其他平台添加回归测试

1. **创建测试脚本**: 参考`cpp_regression_test.py`创建新的测试脚本
2. **准备测试文件**: 创建对应平台的原始测试文件
3. **配置JSON**: 创建对应平台的测试JSON配置
4. **更新文档**: 在本README中添加新平台的说明

### 扩展现有测试

1. **添加测试用例**: 在JSON配置中添加新的API/类/枚举
2. **更新验证逻辑**: 在测试脚本中添加对应的内容检查
3. **调整成功标准**: 根据新增内容调整期望的注释块数量等

## 故障排除

### 常见问题

1. **编码错误**: 确保控制台支持UTF-8编码，或移除emoji字符
2. **路径问题**: 确保在项目根目录运行测试脚本
3. **文件不存在**: 检查`test_original.h`和JSON配置文件是否存在
4. **注入失败**: 检查平台配置和代码定位逻辑是否正确

### 调试技巧

1. **查看详细日志**: 测试脚本会输出详细的执行日志
2. **检查中间文件**: 测试失败时可以查看`src/test.h`的实际内容
3. **单独运行注入**: 可以手动运行注入命令进行调试

## 最佳实践

1. **定期运行**: 在每次代码更改后运行回归测试
2. **保持更新**: 及时更新测试配置和期望输出
3. **版本控制**: 将测试文件纳入版本控制
4. **文档同步**: 保持测试文档与实际测试内容同步
